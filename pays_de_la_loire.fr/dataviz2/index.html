<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "xhtml11.dtd">

<!-- DOC : http://api.highcharts.com/highcharts#chart -->

<html>
<head>
	<meta charset="UTF-8">
	<title>Test</title>
	<script type="text/javascript" src="./jquery.min.js"></script>
	<script type="text/javascript" src="./csvUtil.js"></script>	
	<script type="text/javascript">
	
	// Variables globales
	var chart;
	var donneesGenerales;						// toutes les données du csv
	var donneesTousLesSports = new Array();		// données pour tous les sports
	var regionsDeBase = new Array();			// régions dans l'ordre alphabétique
	
	
	/* ----------------- (chargement des données du csv) */
	var moduleCSV = moduleCSV();
	var regions = new Array();
	var donnees = new Array();
    
	moduleCSV.readTextFile('regions_sans_dom_licencies_par_sport10000_2012.csv', function (csvString) {
		var csvObject = moduleCSV.csvToObject(csvString), prop, premiereLigne = csvObject.firstLine;		
		donneesGenerales = csvObject;

		// Récupération des régions
		regions = premiereLigne.split(';');
		regionsDeBase = premiereLigne.split(';');
			
		// Initialisation du tableau de données (une case par région)
		for (var i=0; i<regions.length; i++) {
			donnees.push(0);
			donneesTousLesSports.push(0);
		}
		
		// Récupération des données (globales, cad somme pour tous les sports)
		var compteur = 0;
		for (prop in csvObject) {
			if ( (compteur>0) && (csvObject.hasOwnProperty(prop))) {
				var ligne = csvObject[prop];
				for (var i=0; i<regions.length; i++) {
					donnees[i] += parseInt(ligne[i]);
					donneesTousLesSports[i] += parseInt(ligne[i]);
				}				
			}
			compteur++;
		}
		
		trierDonnees();
	});
	
	// fonction de tri (à bulles) des données/régions
	function trierDonnees() {
	var changement = true;
		while (changement) {
			changement = false;
			for (var i=0; i<regions.length-1; i++) {
				if (donnees[i] < donnees[i+1]) {
					var tmp1 = regions[i];
					var tmp2 = donnees[i];
					regions[i] = regions[i+1];
					donnees[i] = donnees[i+1];
					regions[i+1] = tmp1;
					donnees[i+1] = tmp2;
					changement = true;
				}
			}
		}
	}
	/* ---------------- (fin de chargement des données) */
	
	
	
	/* ---------------- (data viz) */
	function changerSport(sport) {
		
		chart.setTitle( { text: sport }, {text: ''} );
		
		sport = sport.toString();
		sport = sport.replace(/ /g, "_");
		
		if (sport === 'Tous_les_sports') {
			for (var i=0; i<donneesTousLesSports.length; i++) {
				donnees[i] = donneesTousLesSports[i];
			}
		}
		
		else {
			for (prop in donneesGenerales) {
				if (donneesGenerales.hasOwnProperty(prop)) {
					if (prop.toString() === sport) {
						for (var i=0; i<donneesGenerales[prop].length; i++) {
							donnees[i] = parseInt(donneesGenerales[prop][i]);
						}
					}
				}
			}
		}
					
		for (var i=0; i<regions.length; i++) {
			regions[i] = regionsDeBase[i];
		}

		trierDonnees();

		chart.series[0].update({
			data: donnees
		});
		chart.xAxis[0].setCategories(regions);		
	}
	
	
	// Configuration dataviz
	(function($){ // encapsulate jQuery
		$(function () {
				chart = new Highcharts.Chart({
					chart: {
						renderTo: 'container',
						type: 'bar',
						borderWidth: 1,
					},
					title: {
						text: 'Tous les sports'
					},
					xAxis: {
						categories: regions,
						tickmarkPlacement: 'on',
						labels: { 
							step: 1 
						}
					},
					yAxis: {			
						title: {
							text: 'Nombre de licenciers (pour 10 000 habitants)',
							align: 'high'
						},
						labels: {
							overflow: 'justify'
						},
						gridLineWidth: 0
					},
					series: [{
						name: '2012',
						data: donnees,
						dataLabels: {
							enabled: false
						},
						cursor: 'pointer',
						point: {
							events: {
								click: function() {
									chart.setTitle(null, {text:this.category +', '+ this.y+' licenciés pour 10 000 habitants'});
								}
							}
						}
					}],
					exporting: {
						enabled : false
					},
					plotOptions: {
						bar: {
							dataLabels: { 
								enabled: true 
							}
						}
					},
					legend: { 
						enabled: false 
					},
					credits: {
						enabled: false
					},
					tooltip: { 
						enabled: false 
					}
				});
			});
		})
	(jQuery);
	/* ---------------- (fin data viz) */
	</script>
</head>

<body>
<div id="graph">
	<script src="./highcharts.js"></script>
	<script src="./exporting.js"></script>

	<!-- Menu déroulant (choix des sports) -->
	<select onchange="changerSport(this.value)" name="choixSport">
		<option>Tous les sports</option>
		<option>Athlétisme</option>
		<option>Basket-ball</option>
		<option>Équitation</option>
		<option>Sports sous marins</option>
		<option>Football</option>
		<option>Golf</option>
		<option>Gymnastique</option>
		<option>Handball</option>
		<option>Judo-jujitsu et disciplines associées</option>
		<option>Karaté et arts martiaux affinitaires</option>
		<option>Pétanque et jeu provençal</option>
		<option>Randonnée pédestre</option>
		<option>Rugby</option>
		<option>Ski</option>
		<option>Tennis</option>
		<option>Tennis de table</option>
		<option>Tir</option>
		<option>Voile</option>
		<option>Autres fédérations</option>
    </select>

	<!-- Div dataviz -->
	<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
		
</div>
</body>

</html>